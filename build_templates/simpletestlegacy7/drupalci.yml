# Build Definition Template for the DrupalCI 'SimpletestLegacy' Build Type
environment:
  db:
    type: %DCI_DBType%
    version: %DCI_DBVersion%
  web:
    - %DCI_PHPVersion%
setup:
  checkout:
    # DCI_UseLocalCodebase plugin can override the checkout array to look like:
    # - protocol: local
    #   source_dir: %DCI_SourceDirectory%
    - protocol: git
      repo: %DCI_CoreRepository%
      branch: %DCI_CoreBranch%
      depth: %DCI_GitCheckoutDepth%
      checkout_dir: .
      commit_hash: %DCI_GitCommitHash%
  # Create the directory where we will store our results
  mkdir:
    - /var/www/html/results
    - /var/www/html/artifacts
    - /var/www/html/sites/simpletest/xml
  command:
    - ln -s /var/www/html /var/www/html/checkout
    - chown -fR www-data:www-data /var/www/html
    - chmod 0777 /var/www/html/artifacts
    - chmod 0777 /tmp
dbcreate:
  dbcreate:
    type: %DCI_DBType%
    url: %DCI_DBUrl%
execute:
  command:
    - sudo -u www-data %DCI_PHPInterpreter% -v
    - cd /var/www/html && sudo -u www-data DRUSH_NO_MIN_PHP=1 /.composer/vendor/drush/drush/drush -r /var/www/html si -y --db-url=%DCI_DBurl% --clean-url=0 --account-name=admin --account-pass=drupal --account-mail=admin@example.com
    - cd /var/www/html && sudo -u www-data DRUSH_NO_MIN_PHP=1 /.composer/vendor/drush/drush/drush -r /var/www/html vset simpletest_clear_results '0' 2>&1
    - cd /var/www/html && sudo -u www-data DRUSH_NO_MIN_PHP=1 /.composer/vendor/drush/drush/drush -r /var/www/html vset simpletest_verbose '0' 2>&1
    - cd /var/www/html && sudo -u www-data DRUSH_NO_MIN_PHP=1 /.composer/vendor/drush/drush/drush -r /var/www/html en -y simpletest 2>&1
    # Patch core so we can use --directory in run-tests.sh. Only necessary for
    # commits before 2551981 was added, but it will just fail to apply with no
    # effect for newer versions of core.
    - cd /var/www/html && sudo -u www-data wget -O /var/www/html/2551981-21-add-directory-option-to-run-tests.patch https://www.drupal.org/files/issues/2551981-21-add-directory-option-to-run-tests.patch
    - cd /var/www/html && git apply ./2551981-21-add-directory-option-to-run-tests.patch || true
  testcommand:
    - cd /var/www/html && sudo -u www-data php %DCI_RunScript% --list --php %DCI_PHPInterpreter% > /var/www/html/artifacts/testgroups.txt
  simpletest:
    xmlformat: %DCI_RTXmlPath%
    runtests:
      php: %DCI_PHPInterpreter%
      color: %DCI_RTColor%
      concurrency: %DCI_RTConcurrency%
      # keep-results-table: %DCI_RTKeepResultsTable%
      sqlite: %DCI_SQLite%
      testcommand: cd /var/www/html && sudo -u www-data php %DCI_RunScript%
      testgroups: %DCI_TestGroups%
      #url: http://localhost/checkout
      url: %DCI_RTUrl%
      verbose: %DCI_RTVerbose%
      xml: %DCI_RTXmlPath%
    #- cd /var/www/html && sudo -u www-data php %DCI_RunScript% --php %DCI_PHPInterpreter% --url http://localhost/checkout %DCI_RunOptions% %DCI_TestGroups%
publish:
  gather_artifacts:
    artifact_directory: /var/www/html/artifacts
  junit_xmlformat:
    xml_directory: %DCI_JunitXml%
    # xml_output: %DCI_XMLOutput%
    core_branch: %DCI_CoreBranch%
    db_url: %DCI_DBUrl%
    db_type: %DCI_DBType%
    db_version: %DCI_DBVersion%
    sqlite: %DCI_SQLite%
