# Build Definition Template for the DrupalCI 'Simpletest' Build Type
environment:
  db:
    - %DCI_DBVersion%
  web:
    - %DCI_PHPVersion%
setup:
  checkout:
    # DCI_UseLocalCodebase plugin can override the checkout array to look like:
    # - protocol: local
    #   source_dir: %DCI_SourceDirectory%
    - protocol: git
      repo: %DCI_CoreRepository%
      branch: %DCI_CoreBranch%
      depth: %DCI_GitCheckoutDepth%
      checkout_dir: .
      commit_hash: %DCI_GitCommitHash%
  # Create the directory where we will store our results
  mkdir:
    - /var/www/html/results
    - /var/www/html/artifacts
    - /var/www/html/sites/simpletest/xml
  command:
    - ln -s /var/www/html /var/www/html/checkout
    - chown -fR www-data:www-data /var/www/html/sites /var/www/html/results
    - chmod 0777 /var/www/html/artifacts
    - chmod 0777 /tmp
    - sudo bash -c "/opt/phpenv/shims/pecl list | grep -q yaml && cd /opt/phpenv/versions/ && ls | xargs -I {} -i bash -c 'echo extension=yaml.so > ./{}/etc/conf.d/yaml.ini' || echo -n"
  fetch:
    files: %DCI_Fetch%
  patch:
    files: %DCI_Patch%
  syntaxcheck: true
  composer:
    - install --prefer-dist --working-dir
# The 'install' key is currently required for the dbcreate plugin
# TODO: make dbcreate consistent with other commands and place in pre-install
install:
execute:
  command:
    - supervisorctl start phantomjs
    - php -v
    - php %DCI_RunScript% --list --php /opt/phpenv/shims/php > /var/www/html/artifacts/testgroups.txt
  # Run non-JS tests.
  simpletest:
    xmlformat: %DCI_RTXmlPath%
    runtests:
      color: %DCI_RTColor%
      concurrency: %DCI_RTConcurrency%
      die-on-fail: %DCI_RTDieOnFail%
      dburl: %DCI_DBurl%
      keep-results-table: %DCI_RTKeepResultsTable%
      sqlite: %DCI_SQLite%
      testcommand: cd /var/www/html && sudo -u www-data php %DCI_RunScript%
      testgroups: %DCI_TestGroups%
      types: Simpletest,PHPUnit-Unit,PHPUnit-Kernel,PHPUnit-Functional
      url: %DCI_RTUrl%
      verbose: %DCI_RTVerbose%
      xml: %DCI_RTXmlPath%
  # Run JS tests.
  simpletest:
    xmlformat: %DCI_RTXmlPath%
    runtests:
      color: %DCI_RTColor%
      concurrency: 1
      die-on-fail: %DCI_RTDieOnFail%
      dburl: %DCI_DBurl%
      keep-results-table: TRUE
      sqlite: %DCI_SQLite%
      testcommand: cd /var/www/html && sudo -u www-data php %DCI_RunScript%
      testgroups: %DCI_TestGroups%
      types: PHPUnit-FunctionalJavascript
      url: %DCI_RTUrl%
      verbose: %DCI_RTVerbose%
      xml: %DCI_RTXmlPath%
publish:
  gather_artifacts:
    artifact_directory: /var/www/html/artifacts
  junit_xmlformat:
    xml_directory: %DCI_JunitXml%
    # xml_output: %DCI_XMLOutput%
    core_branch: %DCI_CoreBranch%
    db_url: %DCI_DBUrl&
    db_version: %DCI_DBVersion%
    sqlite: %DCI_SQLite%

  # archive: /var/www/html/results/artifacts.zip
  # junit_xmlformat:

