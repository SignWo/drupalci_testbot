# Job Definition Template for the DrupalCI 'SimpletestLegacy' Job Type
environment:
  db:
    - %DCI_DBVersion%
  web:
    - %DCI_PHPVersion%
setup:
  checkout:
    # DCI_UseLocalCodebase plugin can override the checkout array to look like:
    # - protocol: local
    #   source_dir: %DCI_SourceDirectory%
    - protocol: git
      repo: %DCI_CoreRepository%
      branch: %DCI_CoreBranch%
      depth: %DCI_GitCheckoutDepth%
      checkout_dir: .
  # Create the directory where we will store our results
  mkdir:
    - /var/www/html/results
    - /var/www/html/artifacts
    - /var/www/html/sites/simpletest/xml
  command:
    - chown -fR www-data:www-data /var/www/html
    - chmod 0777 /var/www/html/artifacts
    - chmod 0777 /tmp
# The 'install' key is currently required for the dbcreate plugin
# TODO: make dbcreate consistent with other commands and place in pre-install
install:
execute:
  command:
    - cd /var/www/html
    - ls /tmp
    - sudo -u www-data /.composer/vendor/drush/drush/drush -r /var/www/html si -y --db-url=%DCI_DBurl% --clean-url=0 --account-name=admin --account-pass=drupal --account-mail=admin@example.com
    - sudo -u www-data /.composer/vendor/drush/drush/drush -r /var/www/html vset simpletest_clear_results '0' 2>&1
    - sudo -u www-data /.composer/vendor/drush/drush/drush -r /var/www/html vset simpletest_verbose '0' 2>&1
    - sudo -u www-data /.composer/vendor/drush/drush/drush -r /var/www/html en -y simpletest 2>&1
    - sudo -u www-data php %DCI_RunScript% --list --php %DCI_PHPInterpreter% > /var/www/html/artifacts/testgroups.txt
    - sudo -u www-data php %DCI_RunScript% --url http://localhost %DCI_RunOptions% %DCI_TestGroups%
    - sudo -u www-data sh /tmp/dci-mysql2sqlite.sh -u drupaltestbot -pdrupaltestbotpw -h $(/.composer/vendor/drush/drush/drush -r /var/www/html st | grep "Database hostname" | awk '{print $4}') $(/.composer/vendor/drush/drush/drush -r /var/www/html st | grep "Database name" | awk '{print $4}') simpletest | sqlite3 /var/www/html/artifacts/simpletest.sqlite
    #- sudo -u www-data sh /tmp/dci-mysql2sqlite.sh -u %DCI_DBUser% -p%DCI_DBPass% -h %DCI_DBHostname% %DCI_DBDatabase% simpletest | sqlite3 /var/www/html/artifacts/simpletest.sqlite
publish:
  gather_artifacts: /var/www/html/artifacts
  # archive: /var/www/html/results/artifacts.zip
  # junit_xmlformat:
#  drupalci_results:
#    config: %HOME%/.drupalci/drupalci.yml
